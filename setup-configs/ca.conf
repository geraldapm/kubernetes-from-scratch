### Change 10.96.0. to first-three octets of Kubernetes Service Network Subnet range

# Default values, to be changed in openssl configuration with env expansion
[default]
NODENAME = allnode
NODEIP = 127.0.0.1
HOSTNAME_CP1 = master1
HOSTNAME_CP2 = master2
HOSTNAME_CP3 = master3
IP_CP1 = 10.0.0.1
IP_CP2 = 10.0.0.2
IP_CP3 = 10.0.0.3
FLOATINGIP = 10.0.0.255

[ca]
default_ca = rootca

### Create necessary directory and seed file text
# mkdir -p certs rootca/crl newcerts
# touch index.txt
# echo 1000 > ./rootca/serial
[rootca]
distinguished_name = rootca_distinguished_name
prompt             = no
dir               = ./
certs             = $dir/certs
crl_dir           = $dir/rootca/crl
new_certs_dir     = $dir/newcerts
database          = $dir/rootca/index.txt
serial            = $dir/rootca/serial
RANDFILE          = $dir/rootca/.rand
private_key       = $dir/rootca/ca.key
certificate       = $dir/rootca/ca.crt
crlnumber         = $dir/rootca/crlnumber
crl               = $dir/rootca/crl/ca.crl
crl_extensions    = crl_ext
default_crl_days  = 30
default_md        = sha256
name_opt          = ca_default
cert_opt          = ca_default
default_days      = 375
preserve          = no
policy            = policy_match
x509_extensions   = v3_ca

[rootca_distinguished_name] 
C   = ID
ST  = DKI Jakarta
L   = Jakarta
O   = GPM System Certificate Authority
CN  = GPM System Root CA

[ crl_ext ]
# Extension for CRLs (`man x509v3_config`).
authorityKeyIdentifier=keyid:always

[ ocsp ]
# Extension for OCSP signing certificates (`man ocsp`).
basicConstraints = CA:FALSE
subjectKeyIdentifier = hash
authorityKeyIdentifier = keyid,issuer
keyUsage = critical, digitalSignature
extendedKeyUsage = critical, OCSPSigning

# Policy match only for signing intermediate CA certs
[ policy_match ]
countryName             = match
stateOrProvinceName     = match
organizationName        = match
organizationalUnitName  = optional
commonName              = supplied
emailAddress            = optional

# Policy anyting for signing end user certs
[ policy_anything ]
countryName             = optional
stateOrProvinceName     = optional
localityName            = optional
organizationName        = optional
organizationalUnitName  = optional
commonName              = supplied
emailAddress            = optional

# Kubernetes CA
[kubernetes-ca]
distinguished_name = kubernetes-ca_distinguished_name
prompt             = no
x509_extensions    = v3_intermediate_ca
default_md         = sha256

[kubernetes-ca_distinguished_name] 
C   = ID
ST  = DKI Jakarta
L   = Jakarta
O   = GPM System Certificate Authority
CN  = kubernetes-ca

# etcd CA
[etcd-ca]
distinguished_name = etcd-ca_distinguished_name
prompt             = no
x509_extensions    = v3_intermediate_ca
default_md         = sha256

[etcd-ca_distinguished_name] 
C   = ID
ST  = DKI Jakarta
L   = Jakarta
O   = GPM System Certificate Authority
CN  = etcd-ca

# front-proxy CA
[front-proxy-ca]
distinguished_name = front-proxy-ca_distinguished_name
prompt             = no
x509_extensions    = v3_intermediate_ca
default_md         = sha256

[front-proxy-ca_distinguished_name] 
C   = ID
ST  = DKI Jakarta
L   = Jakarta
O   = GPM System Certificate Authority
CN  = kubernetes-front-proxy-ca

[ v3_ca ]
# Extensions for a typical CA (`man x509v3_config`).
subjectKeyIdentifier = hash
authorityKeyIdentifier = keyid:always,issuer
basicConstraints = critical, CA:true
keyUsage = critical, digitalSignature, cRLSign, keyCertSign

[ v3_intermediate_ca ]
# Extensions for a typical intermediate CA (`man x509v3_config`).
# pathlen:0 ensures that the CA cannot sign another CA
subjectKeyIdentifier = hash
authorityKeyIdentifier = keyid:always,issuer
basicConstraints = critical, CA:true, pathlen:0
keyUsage = critical, digitalSignature, cRLSign, keyCertSign


[req]
distinguished_name = req_distinguished_name
prompt             = no
x509_extensions    = ca_x509_extensions
default_md         = sha256

[ca_x509_extensions]
basicConstraints = CA:TRUE
keyUsage         = cRLSign, keyCertSign

[req_distinguished_name] 
C   = ID
ST  = DKI Jakarta
L   = Jakarta
CN  = CA

[admin]
distinguished_name = admin_distinguished_name
prompt             = no
req_extensions     = default_req_extensions

[admin_distinguished_name]
CN = admin
O  = system:masters

[super-admin]
distinguished_name = super-admin_distinguished_name
prompt             = no
req_extensions     = default_req_extensions

[super-admin_distinguished_name]
CN = super-admin
O  = system:masters

# Service Accounts
#
# The Kubernetes Controller Manager leverages a key pair to generate
# and sign service account tokens as described in the
# [managing service accounts](https://kubernetes.io/docs/admin/service-accounts-admin/)
# documentation.

[service-accounts]
distinguished_name = service-accounts_distinguished_name
prompt             = no
req_extensions     = default_req_extensions

[service-accounts_distinguished_name]
CN = service-accounts

# Worker Nodes
#
# Kubernetes uses a [special-purpose authorization mode](https://kubernetes.io/docs/admin/authorization/node/)
# called Node Authorizer, that specifically authorizes API requests made
# by [Kubelets](https://kubernetes.io/docs/concepts/overview/components/#kubelet).
# In order to be authorized by the Node Authorizer, Kubelets must use a credential
# that identifies them as being in the `system:nodes` group, with a username
# of `system:node:<nodeName>`.

[allnode]
distinguished_name = allnode_distinguished_name
prompt             = no
req_extensions     = allnode_req_extensions

[allnode_req_extensions]
basicConstraints     = CA:FALSE
extendedKeyUsage     = clientAuth, serverAuth
keyUsage             = critical, digitalSignature, keyEncipherment
nsCertType           = client
nsComment            = "allnode Certificate"
subjectAltName       = @allnode_alt_names
subjectKeyIdentifier = hash

[allnode_alt_names]
IP.0  = 127.0.0.1
IP.1  = ${ENV::NODEIP}
DNS.0 = localhost
DNS.1 = ${ENV::NODENAME}

[allnode_distinguished_name]
CN = system:node:${ENV::NODENAME}
O  = system:nodes
C  = ID
ST = DKI Jakarta
L  = Jakarta

# Kube Proxy Section
[kube-proxy]
distinguished_name = kube-proxy_distinguished_name
prompt             = no
req_extensions     = kube-proxy_req_extensions

[kube-proxy_req_extensions]
basicConstraints     = CA:FALSE
extendedKeyUsage     = clientAuth, serverAuth
keyUsage             = critical, digitalSignature, keyEncipherment
nsCertType           = client
nsComment            = "Kube Proxy Certificate"
subjectAltName       = @kube-proxy_alt_names
subjectKeyIdentifier = hash

[kube-proxy_alt_names]
IP.0  = 127.0.0.1
DNS.0 = localhost
DNS.1 = kube-proxy

[kube-proxy_distinguished_name]
CN = system:kube-proxy
O  = system:node-proxier
C  = ID
ST = DKI Jakarta
L  = Jakarta


# Controller Manager
[kube-controller-manager]
distinguished_name = kube-controller-manager_distinguished_name
prompt             = no
req_extensions     = kube-controller-manager_req_extensions

[kube-controller-manager_req_extensions]
basicConstraints     = CA:FALSE
extendedKeyUsage     = clientAuth, serverAuth
keyUsage             = critical, digitalSignature, keyEncipherment
nsCertType           = client
nsComment            = "Kube Controller Manager Certificate"
subjectAltName       = @kube-controller-manager_alt_names
subjectKeyIdentifier = hash

[kube-controller-manager_alt_names]
IP.0  = 127.0.0.1
DNS.0 = localhost
DNS.1 = kube-controller-manager

[kube-controller-manager_distinguished_name]
CN = system:kube-controller-manager
O  = system:kube-controller-manager
C  = ID
ST = DKI Jakarta
L  = Jakarta


# Scheduler
[kube-scheduler]
distinguished_name = kube-scheduler_distinguished_name
prompt             = no
req_extensions     = kube-scheduler_req_extensions

[kube-scheduler_req_extensions]
basicConstraints     = CA:FALSE
extendedKeyUsage     = clientAuth, serverAuth
keyUsage             = critical, digitalSignature, keyEncipherment
nsCertType           = client
nsComment            = "Kube Scheduler Certificate"
subjectAltName       = @kube-scheduler_alt_names
subjectKeyIdentifier = hash

[kube-scheduler_alt_names]
IP.0  = 127.0.0.1
DNS.0 = localhost
DNS.1 = kube-scheduler

[kube-scheduler_distinguished_name]
CN = system:kube-scheduler
O  = system:system:kube-scheduler
C  = ID
ST = DKI Jakarta
L  = Jakarta

# API Server
#
# The Kubernetes API server is automatically assigned the `kubernetes`
# internal dns name, which will be linked to the first IP address (`10.96.0.1`)
# from the address range (`10.96.0.0/12`) reserved for internal cluster
# services.
# Change the 10.96.0.1 address to any desired service Subnet Range IP

[kube-apiserver]
distinguished_name = kube-apiserver_distinguished_name
prompt             = no
req_extensions     = kube-apiserver_req_extensions

[kube-apiserver_req_extensions]
basicConstraints     = CA:FALSE
extendedKeyUsage     = clientAuth, serverAuth
keyUsage             = critical, digitalSignature, keyEncipherment
nsCertType           = client, server
nsComment            = "Kube API Server Certificate"
subjectAltName       = @kube-apiserver_alt_names
subjectKeyIdentifier = hash

[kube-apiserver_alt_names]
IP.0  = 127.0.0.1
IP.1  = 10.96.0.1
DNS.0 = kubernetes
DNS.1 = kubernetes.default
DNS.2 = kubernetes.default.svc
DNS.3 = kubernetes.default.svc.cluster
DNS.4 = kubernetes.svc.cluster.local
DNS.5 = server.kubernetes.local
DNS.6 = api-server.kubernetes.local
DNS.7 = apiserver.kubernetes.local
DNS.8 = localhost
### Each Control Plane Hostname, IP and Floating IP
IP.2  = ${ENV::IP_CP1}
IP.3  = ${ENV::IP_CP2}
IP.4  = ${ENV::IP_CP3}
DNS.9  = ${ENV::HOSTNAME_CP1}
DNS.10 = ${ENV::HOSTNAME_CP2}
DNS.11 = ${ENV::HOSTNAME_CP3}
IP.5  = ${ENV::FLOATINGIP}

[kube-apiserver_distinguished_name]
CN = kubernetes
C  = ID
ST = DKI Jakarta
L  = Jakarta

[default_req_extensions]
basicConstraints     = CA:FALSE
extendedKeyUsage     = clientAuth
keyUsage             = critical, digitalSignature, keyEncipherment
nsCertType           = client
nsComment            = "Admin Client Certificate"
subjectKeyIdentifier = hash

# ETCD
# It is used as etcd-server cert and etcd-peer cert
[kube-etcd]
distinguished_name = kube-etcd_distinguished_name
prompt             = no
req_extensions     = kube-etcd_req_extensions

[kube-etcd_req_extensions]
basicConstraints     = CA:FALSE
extendedKeyUsage     = clientAuth, serverAuth
keyUsage             = critical, digitalSignature, keyEncipherment
nsCertType           = client
nsComment            = "Kube ETCD Certificate"
subjectAltName       = @kube-etcd_alt_names
subjectKeyIdentifier = hash

[kube-etcd_alt_names]
IP.0  = 127.0.0.1
DNS.1 = localhost
### Each Control Plane Hostname, IP and Floating IP
IP.2  = ${ENV::IP_CP1}
IP.3  = ${ENV::IP_CP2}
IP.4  = ${ENV::IP_CP3}
DNS.9  = ${ENV::HOSTNAME_CP1}
DNS.10 = ${ENV::HOSTNAME_CP2}
DNS.11 = ${ENV::HOSTNAME_CP3}
IP.5  = ${ENV::FLOATINGIP}

[kube-etcd_distinguished_name]
CN = etcd-server
O  = system:system:etcd-server
C  = ID
ST = DKI Jakarta
L  = Jakarta

### kube-apiserver-kubelet-client
[kube-apiserver-kubelet-client]
distinguished_name = kube-apiserver-kubelet-client_distinguished_name
prompt             = no
req_extensions     = kube-apiserver-kubelet-client_req_extensions

[kube-apiserver-kubelet-client_req_extensions]
basicConstraints     = CA:FALSE
extendedKeyUsage     = clientAuth, serverAuth
keyUsage             = critical, digitalSignature, keyEncipherment
nsCertType           = client
nsComment            = "kube-apiserver-kubelet-client Certificate"
subjectAltName       = @kube-apiserver-kubelet-client_alt_names
subjectKeyIdentifier = hash

[kube-apiserver-kubelet-client_alt_names]
IP.0  = 127.0.0.1
DNS.0 = localhost
DNS.1 = kube-apiserver-kubelet-client

[kube-apiserver-kubelet-client_distinguished_name]
CN = kube-apiserver-kubelet-client
O  = system:masters
C  = ID
ST = DKI Jakarta
L  = Jakarta

### kube-apiserver-etcd-client
[kube-apiserver-etcd-client]
distinguished_name = kube-apiserver-etcd-client_distinguished_name
prompt             = no
req_extensions     = kube-apiserver-etcd-client_req_extensions

[kube-apiserver-etcd-client_req_extensions]
basicConstraints     = CA:FALSE
extendedKeyUsage     = clientAuth, serverAuth
keyUsage             = critical, digitalSignature, keyEncipherment
nsCertType           = client
nsComment            = "kube-apiserver-etcd-client Certificate"
subjectAltName       = @kube-apiserver-etcd-client_alt_names
subjectKeyIdentifier = hash

[kube-apiserver-etcd-client_alt_names]
IP.0  = 127.0.0.1
DNS.0 = localhost
DNS.1 = kube-apiserver-etcd-client

[kube-apiserver-etcd-client_distinguished_name]
CN = kube-apiserver-etcd-client
O  = system:masters
C  = ID
ST = DKI Jakarta
L  = Jakarta

### front-proxy-client
[front-proxy-client]
distinguished_name = front-proxy-client_distinguished_name
prompt             = no
req_extensions     = front-proxy-client_req_extensions

[front-proxy-client_req_extensions]
basicConstraints     = CA:FALSE
extendedKeyUsage     = clientAuth, serverAuth
keyUsage             = critical, digitalSignature, keyEncipherment
nsCertType           = client
nsComment            = "front-proxy-client Certificate"
subjectAltName       = @front-proxy-client_alt_names
subjectKeyIdentifier = hash

[front-proxy-client_alt_names]
IP.0  = 127.0.0.1
DNS.0 = localhost
DNS.1 = front-proxy-client

[front-proxy-client_distinguished_name]
CN = front-proxy-client
O  = system:masters
C  = ID
ST = DKI Jakarta
L  = Jakarta